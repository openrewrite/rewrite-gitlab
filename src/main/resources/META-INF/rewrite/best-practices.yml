#
# Copyright 2025 the original author or authors.
# <p>
# Licensed under the Moderne Source Available License (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
# <p>
# https://docs.moderne.io/licensing/moderne-source-available-license
# <p>
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.gitlab.BestPractices
displayName: GitLab CI best practices
description: >-
  Apply GitLab CI/CD best practices to `.gitlab-ci.yml`. This includes
  adding `workflow:rules` to prevent duplicate pipelines, setting
  `interruptible: true` and `retry` in the `default` section,
  configuring `artifacts:expire_in`, and setting a job `timeout`.
tags:
  - gitlab
  - ci
recipeList:
  - org.openrewrite.gitlab.MigrateOnlyToRules
  - org.openrewrite.gitlab.MigrateExceptToRules
  - org.openrewrite.gitlab.AddWorkflowRules:
      rules: |-
        - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
        - if: $CI_COMMIT_BRANCH && $CI_OPEN_MERGE_REQUESTS
          when: never
        - if: $CI_COMMIT_BRANCH
  - org.openrewrite.gitlab.AddInterruptible
  - org.openrewrite.gitlab.AddRetry:
      max: 2
      when:
        - runner_system_failure
        - stuck_or_timeout_failure
  - org.openrewrite.gitlab.AddArtifactsExpireIn:
      expireIn: 1 week
  - org.openrewrite.gitlab.AddTimeout:
      timeout: 1 hour
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.gitlab.search.FindDeprecatedSyntax
displayName: Find deprecated GitLab CI syntax
description: >-
  Find usages of deprecated `only` and `except` keywords in `.gitlab-ci.yml`.
  These keywords are deprecated in favor of `rules`.
tags:
  - gitlab
  - ci
  - search
recipeList:
  - org.openrewrite.gitlab.search.FindDeprecatedOnly
  - org.openrewrite.gitlab.search.FindDeprecatedExcept
---
type: specs.openrewrite.org/v1beta/recipe
name: org.openrewrite.gitlab.MigrateDeprecatedSyntax
displayName: Migrate deprecated GitLab CI syntax
description: >-
  Migrate deprecated `only` and `except` keywords to equivalent `rules`
  in `.gitlab-ci.yml`.
tags:
  - gitlab
  - ci
recipeList:
  - org.openrewrite.gitlab.MigrateOnlyToRules
  - org.openrewrite.gitlab.MigrateExceptToRules
